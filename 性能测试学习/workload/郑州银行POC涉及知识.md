ref

[郑州银行POC - 腾讯iWiki (woa.com)](https://iwiki.woa.com/p/4010979429)





# pq计划与legacy pq计划

1. 查询计划（Query Plan）

查询计划是数据库在执行SQL查询时生成的一系列步骤，用于高效地检索和处理数据。不同的查询计划会影响查询的性能。

2. 并行查询（Parallel Query，PQ）

并行查询是指数据库系统将一个查询任务分解成多个子任务，并行执行以提高查询性能。TDSQL支持并行查询来加速数据处理。

3. `partial_plan` 和 `multi_partial_plan`

这两个参数是TDSQL中用于控制并行查询计划生成的设置。

- **`partial_plan`**：启用部分并行查询计划。这个设置允许数据库在生成查询计划时考虑部分并行执行的可能性。
- **`multi_partial_plan`**：启用多部分并行查询计划。这个设置允许数据库在生成查询计划时考虑多个部分并行执行的可能性。

4. 无法产生PQ计划

当同时设置 `partial_plan` 和 `multi_partial_plan` 时，数据库系统可能会遇到冲突或复杂性，导致无法生成标准的并行查询计划（PQ计划）。

5. 产生Legacy PQ计划

Legacy PQ计划指的是数据库系统在早期版本中使用的并行查询计划生成机制。即使在新的设置下无法生成标准PQ计划，系统仍然可以回退到旧的机制来生成并行查询计划。

当你同时启用 `partial_plan` 和 `multi_partial_plan` 时，数据库系统可能会因为这两个设置的复杂性或冲突，无法生成标准的并行查询计划（PQ计划）。然而，系统会回退到使用旧的并行查询计划生成机制（Legacy PQ计划），以确保查询仍然能够并行执行。





并行查询（Parallel Query，简称 PQ）和传统并行查询（Legacy PQ）在表现形式上有一些显著的区别。以下是一些关键区别：

### 1. 执行计划的结构

#### PQ 计划

- **现代 PQ 计划**：现代并行查询计划通常会显示多个并行执行的操作步骤。这些步骤可能包括并行扫描、并行连接、并行聚合等。
- **执行节点**：现代 PQ 计划会显示多个执行节点（worker nodes），每个节点负责一部分数据的处理。
- **协调节点**：通常会有一个协调节点（coordinator node），负责汇总各个执行节点的结果。

#### Legacy PQ 计划

- **传统 PQ 计划**：传统并行查询计划可能不会显示详细的并行执行步骤，而是以较为简单的形式展示。
- **单一执行路径**：传统 PQ 计划可能会显示单一的执行路径，缺乏对并行执行细节的展示。
- **较少的并行信息**：传统 PQ 计划中，关于并行度、执行节点等信息可能较少或缺乏。

### 2. 执行计划的输出格式

#### PQ 计划

- **详细信息**：现代 PQ 计划通常会提供更详细的信息，包括每个并行操作的执行时间、数据量、并行度等。
- **图形化表示**：一些数据库管理工具可能会提供图形化的执行计划表示，清晰展示并行操作的关系和数据流。

#### Legacy PQ 计划

- **简化信息**：传统 PQ 计划通常提供简化的信息，可能缺乏对并行操作的详细描述。
- **文本表示**：传统 PQ 计划通常以文本形式展示，缺乏图形化表示。

### 3. 性能和优化

#### PQ 计划

- **优化器改进**：现代 PQ 计划通常由改进的查询优化器生成，能够更好地利用多核处理器和分布式计算资源。
- **动态调整**：现代 PQ 计划可能支持动态调整并行度，根据系统负载和资源情况进行优化。

#### Legacy PQ 计划

- **优化器限制**：传统 PQ 计划可能由较旧的查询优化器生成，优化能力有限。
- **固定并行度**：传统 PQ 计划可能使用固定的并行度，缺乏动态调整能力。

### 示例对比

假设我们有一个简单的查询：

```sql
SELECT id, contract_no, business_date
FROM ants_loan_init
WHERE write_off = 'Y'
ORDER BY id ASC
LIMIT 1000;
```

#### PQ 计划示例

```plaintext
| -> Limit: 1000 row(s)
    -> Gather
        Workers Planned: 4
        -> Parallel Seq Scan on ants_loan_init
            Filter: (write_off = 'Y')
            -> Sort
                Sort Key: id
```

在这个示例中，`Gather` 节点表示协调节点，`Parallel Seq Scan` 表示并行扫描操作，`Workers Planned: 4` 表示计划使用 4 个并行工作节点。

#### Legacy PQ 计划示例

```plaintext
| -> Limit: 1000 row(s)
    -> Seq Scan on ants_loan_init
        Filter: (write_off = 'Y')
        -> Sort
            Sort Key: id
```

在这个示例中，没有显示并行操作的详细信息，只有一个顺序扫描和排序操作。

### 总结

PQ 计划和 Legacy PQ 计划在表现形式上的主要区别在于：

1. **执行计划的结构**：现代 PQ 计划显示详细的并行执行步骤和执行节点，而传统 PQ 计划通常较为简化。
2. **执行计划的输出格式**：现代 PQ 计划提供更详细的信息和可能的图形化表示，而传统 PQ 计划通常以简化的文本形式展示。
3. **性能和优化**：现代 PQ 计划由改进的查询优化器生成，支持动态调整并行度，而传统 PQ 计划优化能力有限，通常使用固定并行度。







当你在 MySQL 中使用 `EXPLAIN FORMAT=TREE` 语句时，遇到 `<not executable by iterator executor>` 错误，这通常表示 MySQL 的查询优化器无法生成树格式的执行计划，特别是对于复杂的 `UPDATE` 语句。





OUTFILE 使用