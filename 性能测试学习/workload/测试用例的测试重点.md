| name |                             sql                              | 分析                                                         | 复现与备注（sqlengine-0.0.1 20240715 e7ef59adadd）           |
| :--: | :----------------------------------------------------------: | ------------------------------------------------------------ | :----------------------------------------------------------- |
| Sql1 | explain SELECT id,serialno,transserialno,transcode,relativeobjectno,currency,accountcodeno,exaccountcodeno,amount,direction,remark,subdetailtype,bus_date FROM wb_acct_subledger_detail WHERE bus_date = (select today from pr_cc_organization_table where id ='80000023') and transcode = '3020' and source='1' ORDER BY id ASC LIMIT 10000; | 同时设置partial_plan与multi_partial_plan时，能否下推问题。<br/> | 均可以下推                                                   |
| Sql2 | explain format=tree SELECT id, contract_no, business_date FROM ants_loan_init WHERE write_off = 'Y' AND business_date = ( SELECT today FROM pr_cc_organization_table WHERE id = '80000023' ) AND contract_no NOT IN ( SELECT contract_no FROM ants_write_off ) AND contract_no NOT IN ( SELECT contract_no FROM ants_loan_detail_acct WHERE `status` IN ('COMPEN', 'SETTLEMENT') ) ORDER BY id ASC LIMIT 1000; | 同时设置partial_plan与multi_partial_plan时，无法产生pq计划,可以产生legacy pq计划。 | 只能生成legacy pq计划                                        |
| Sql4 | explain format=tree SELECT a.* from hb_bill_loan_detail a LEFT JOIN  BM_CO_CUSTOMER_PERSONAL b on b.id_number=a.cert_no and b.partner_channel='13000010000303000000001' where b.cust_number is null; | 开启partial_plan可以并行，关闭后不能并行                     | 开启partial_plan后，好像还不能并行                           |
| 5--  | explain format=tree select bmloacctlo0_.partner_channel as col_0_0_, bmloacctlo0_.loan_order_number as col_1_0_, bmloacctlo0_.txn_posting_amnt as col_2_0_, bmloacctlo0_.loan_total_principal_balance as col_3_0_, bmloacctlo0_.loan_level_type as col_4_0_ from bm_lo_acct_loan bmloacctlo0_ where bmloacctlo0_.txa_status=1 or bmloacctlo0_.txa_status=8 and bmloacctlo0_.loan_close_payment_date=(select prccorgani1_.today from pr_cc_organization_table prccorgani1_ where prccorgani1_.id='80000023') and bmloacctlo0_.txn_create_date<>bmloacctlo0_.loan_close_payment_date limit 100, 100; | **spilder在sql在，但set上已经没有了 3000+秒**                | 奇怪，这个生成PQ计划了                                       |
|  6   | explain format=tree SELECT t.package_date, t.encash_amount, t.avg_borrow_days, t.ovd_balance_90, ROUND(t.ovd_balance_90/t.encash_amount, 10), if(avg_borrow_days=0,0,ROUND(360/t.avg_borrow_days * (t.ovd_balance_90/t.encash_amount), 10)),  NAME_CONST('varDate',_latin1'2024-03-25' COLLATE 'latin1_swedish_ci') FROM (SELECT DATE_FORMAT(business_date, '%Y-%m-00') as package_date, SUM(encash_amt)/100 as encash_amount, SUM(DATEDIFF(IF(clear_date = '',  NAME_CONST('varDate','2024-03-25'), clear_date), business_date) * encash_amt)/SUM(encash_amt) as avg_borrow_days, SUM(IF(GREATEST(prin_ovd_days, int_ovd_days) >= 90, prin_bal+ovd_prin_bal, 0))/100 as ovd_balance_90 FROM ants_loan_detail_acct WHERE business_date >='2019-09-01' GROUP BY DATE_FORMAT(business_date, '%Y-%m') )t; | **单表扫描，set间是走的串行 -- 解决**                        | 问题已解决                                                   |
|  7   | SELECT SUM(prin_bal + ovd_prin_bal)/100 , DATE_FORMAT(business_date, '%Y-%m-00'), NAME_CONST('varDate',_latin1'2024-03-25' COLLATE 'latin1_swedish_ci'), CURRENT_TIMESTAMP() FROM ants_loan_detail_acct WHERE business_date >='2019-09-01' GROUP BY DATE_FORMAT(business_date, '%Y-%m'); | Data aggregation speed                                       |                                                              |
|  12  | explain format=tree select bmlosubjec0_.txa_number as col_0_0_, bmlosubjec0_.txa_type as col_1_0_, bmlosubjec0_.subject_code as col_2_0_, bmlosubjec0_.subject_desc as col_3_0_, sum(bmlosubjec0_.amount) as col_4_0_, bmlosubjec0_.txa_post_time as col_5_0_, bmlosubjec0_.create_time as col_6_0_, bmlosubjec0_.now_business_date as col_7_0_, bmlosubjec0_.txn_code as col_8_0_, bmlosubjec0_.flag as col_9_0_, bmlosubjec0_.txn_orig_txa_number as col_10_0_, bmlosubjec0_.channel_code as col_11_0_, bmlosubjec0_.cust_number as col_12_0_, bmlosubjec0_.tran_sq as col_13_0_, bmlosubjec0_.vchr_sq as col_14_0_, bmlosubjec0_.loan_order_number as col_15_0_, bmlosubjec0_.organization_id as col_16_0_ from bm_lo_subject_detail bmlosubjec0_ where bmlosubjec0_.now_business_date=date_format((select prccorgani1_.today from pr_cc_organization_table prccorgani1_ where prccorgani1_.id='80000023'), '%Y-%m-%d') group by bmlosubjec0_.subject_code , bmlosubjec0_.flag , bmlosubjec0_.organization_id order by bmlosubjec0_.txa_number asc limit 20000; | **spilder直接崩了**                                          | 已修复                                                       |
|  14  | explain format=tree insert into `hb_bill_first_loan_info` (`id`,`contract_no`, `contract_type`, `name`, `cert_type`, `cert_no`, `business_date`) select d.id,d.contract_no, d.contract_type, d.`name`, d.cert_type, d.cert_no, d.business_date from hb_bill_loan_detail_acct d left JOIN hb_bill_first_loan_info f on d.cert_no = f.cert_no where f.id is null and d.business_date =  NAME_CONST('varDate',_latin1'2024-03-25' COLLATE 'latin1_swedish_ci') group by d.cert_no; | **不走FQS  -- 0620 关联没有分片键，无法下推**                |                                                              |
|  15  | explain format=tree  select wbloaninfo0_.id as id1_434_, wbloaninfo0_.bus_date as bus_date2_434_, wbloaninfo0_.create_time as create_t3_434_, wbloaninfo0_.last_update_time as last_upd4_434_, wbloaninfo0_.absstatus as absstatu5_434_, wbloaninfo0_.balance as balance6_434_, wbloaninfo0_.bond_acct_no as bond_acc7_434_, wbloaninfo0_.bond_date as bond_dat8_434_, wbloaninfo0_.businesscurrency as business9_434_, wbloaninfo0_.businessrate as busines10_434_, wbloaninfo0_.businesssum as busines11_434_, wbloaninfo0_.contract_no as contrac12_434_, wbloaninfo0_.corpuspaymethod as corpusp13_434_, wbloaninfo0_.customerid as custome14_434_, wbloaninfo0_.data_dt as data_dt15_434_, wbloaninfo0_.fullname as fullnam16_434_, wbloaninfo0_.in_acct_bank as in_acct17_434_, wbloaninfo0_.in_acct_bank_no as in_acct18_434_, wbloaninfo0_.in_acct_no as in_acct19_434_, wbloaninfo0_.in_acct_no_name as in_acct20_434_, wbloaninfo0_.lending_ref as lending21_434_, wbloaninfo0_.loan_usage as loan_us22_434_, wbloaninfo0_.loanchangfrequency as loancha23_434_, wbloaninfo0_.loanstatus as loansta24_434_, wbloaninfo0_.lprbaserate as lprbase25_434_, wbloaninfo0_.maturity as maturit26_434_, wbloaninfo0_.oper_org as oper_or27_434_, wbloaninfo0_.overduefine as overdue28_434_, wbloaninfo0_.pay_acct_bank as pay_acc29_434_, wbloaninfo0_.pay_acct_bank_no as pay_acc30_434_, wbloaninfo0_.pay_acct_no as pay_acc31_434_, wbloaninfo0_.pay_acct_no_name as pay_acc32_434_, wbloaninfo0_.payday as payday33_434_, wbloaninfo0_.project_id as project34_434_, wbloaninfo0_.putoutdate as putoutd35_434_, wbloaninfo0_.seqno as seqno36_434_, wbloaninfo0_.source as source37_434_, wbloaninfo0_.startinterestdate as startin38_434_, wbloaninfo0_.status as status39_434_, wbloaninfo0_.termdate as termdat40_434_, wbloaninfo0_.termflag as termfla41_434_, wbloaninfo0_.tremmonth as tremmon42_434_, wbloaninfo0_.type_of_cust as type_of43_434_ from wb_loan wbloaninfo0_ cross join pr_cc_organization_table prccorgani1_ where wbloaninfo0_.bus_date=prccorgani1_.today and prccorgani1_.id='80000023' order by wbloaninfo0_.id desc limit 10000, 10000; | **不走FQS, 后台还转为了 like的写的法**                       | 已修复,打开  set global tdsql_disable_const_tables_for_pq=on; 之后，走了并行 |
|  16  | explain format=tree select COALESCE(sum(prin_bal+ovd_prin_bal),0) from hb_bill_daily_init_info where write_off = 'Y' and business_date = '2024-03-25 00:00:00' and contract_no not in (select contract_no from hb_write_off_table where business_date < '2024-03-25 00:00:00'); | 与13重复                                                     |                                                              |
|  18  | explain format=tree select antsloanca0_.id as id1_44_, antsloanca0_.accrued_status as accrued_2_44_, antsloanca0_.business_date as business3_44_, antsloanca0_.calc_date as calc_dat4_44_, antsloanca0_.contract_no as contract5_44_, antsloanca0_.create_time as create_t6_44_, antsloanca0_.int_amt as int_amt7_44_, antsloanca0_.last_update_time as last_upd8_44_, antsloanca0_.ovd_int_bal as ovd_int_9_44_, antsloanca0_.ovd_int_pnlt_amt as ovd_int10_44_, antsloanca0_.ovd_prin_bal as ovd_pri11_44_, antsloanca0_.ovd_prin_pnlt_amt as ovd_pri12_44_, antsloanca0_.pnlt_rate as pnlt_ra13_44_, antsloanca0_.prin_bal as prin_ba14_44_, antsloanca0_.processor_flg as process15_44_, antsloanca0_.processor_flg_diff as process16_44_, antsloanca0_.real_rate as real_ra17_44_, antsloanca0_.write_off as write_o18_44_ from ants_loan_calc antsloanca0_ where antsloanca0_.business_date=(select date_format(prccorgani1_.today, '%Y-%m-%d') from pr_cc_organization_table prccorgani1_ where prccorgani1_.id='80000023') order by antsloanca0_.id asc limit 300000, 20000; | **执行计划是否合理 -- 已proxy并行，可能要db并行**            | db并行怎么看                                                 |
| 20-- | explain format=tree select ifnull(jrx_fee_amt,''), ifnull(bcd_diff_int_amt,''), ifnull(bcd_free_int_amt,''), ifnull(DATE_ADD(settle_date,INTERVAL 1 DAY),''), ifnull(DATE_ADD(start_date,INTERVAL 1 DAY),''), ifnull(DATE_ADD(end_date,INTERVAL 1 DAY),''), ifnull(DATE_ADD(clear_date,INTERVAL 1 DAY),''), ifnull(DATE_ADD(business_date,INTERVAL 1 DAY),'') FROM ants_repay_plan_acct; | ifnull function                                              |                                                              |
| 22-- | explain format=tree select ifnull(r.ants_fee_amt, ''), ifnull(r.jrx_fee_amt, ''), ifnull(r.bcd_diff_int_amt, ''), ifnull(r.bcd_free_int_amt, '') FROM ants_repay_plan_acct r, ants_loan_detail_acct d WHERE d.STATUS IN ('OVD', 'WRITEOFF') AND d.contract_no = r.contract_no | **select output 多表关联**                                   |                                                              |
|  28  | explain format=tree select wbloandeta0_.insurance_payment_prin as insuran55_440_, wbloandeta0_.int_od_amt as int_od_56_440_, wbloandeta0_.int_od_date as int_od_57_440_, wbloandeta0_.interest as interes58_440_, wbloandeta0_.interest_all_paid_date as interes59_440_, wbloandeta0_.interest_paid_amt as interes60_440_, wbloandeta0_.intr_typ as intr_ty61_440_, wbloandeta0_.laidoff_loan_type as laidoff62_440_, wbloandeta0_.lending_ref as lending63_440_, wbloandeta0_.limit_report_no as limit_r64_440_, wbloandeta0_.loan_process_flag as loan_pr65_440_, wbloandeta0_.loan_purpose as loan_pu66_440_, wbloandeta0_.loan_type as loan_ty67_440_, wbloandeta0_.loan_type_stage as loan_ty68_440_, wbloandeta0_.management_flag as managem69_440_, wbloandeta0_.maturity_date as maturit70_440_, wbloandeta0_.month_rate as month_r71_440_, wbloandeta0_.org_id as org_id72_440_, wbloandeta0_.original_maturity_d as origina73_440_, wbloandeta0_.original_maturity_m as origina74_440_, wbloandeta0_.overdue_days as overdue75_440_, wbloandeta0_.overdue_type as overdue76_440_, wbloandeta0_.p_cancel_date as p_cance77_440_, wbloandeta0_.p_curr_term as p_curr_78_440_, wbloandeta0_.p_init_term as p_init_79_440_, wbloandeta0_.p_overdue_amt as p_overd80_440_, wbloandeta0_.packet_balance as packet_81_440_, wbloandeta0_.packet_date as packet_82_440_, wbloandeta0_.paid_out_date as paid_ou83_440_, wbloandeta0_.pay_way as pay_way84_440_, wbloandeta0_.payment_feq as payment85_440_, wbloandeta0_.person_add_loan_flg as person_86_440_, wbloandeta0_.pmt_due_date as pmt_due87_440_, wbloandeta0_.pre_spe as pre_spe88_440_, wbloandeta0_.prin_od_amt as prin_od89_440_, wbloandeta0_.prin_od_date as prin_od90_440_, wbloandeta0_.product_stcode as product91_440_, wbloandeta0_.rate as rate92_440_, wbloandeta0_.rate_float_type as rate_fl93_440_, wbloandeta0_.rate_type as rate_ty94_440_, wbloandeta0_.real_estate_type as real_es95_440_, wbloandeta0_.recom_date as recom_d96_440_, wbloandeta0_.recom_flg as recom_f97_440_, wbloandeta0_.relativeddloanno as relativ98_440_, wbloandeta0_.remaining_maturity_d as remaini99_440_, wbloandeta0_.remaining_maturity_m as remain100_440_, wbloandeta0_.repricing_date as repric101_440_, wbloandeta0_.repricing_maturity_d as repric102_440_, wbloandeta0_.repricing_maturity_m as repric103_440_, wbloandeta0_.reserve as reserv104_440_, wbloandeta0_.sch_maturity_date as sch_ma105_440_, wbloandeta0_.ser_no as ser_no106_440_, wbloandeta0_.smelt_type as smelt_107_440_, wbloandeta0_.source as source108_440_, wbloandeta0_.special_prep as specia109_440_, wbloandeta0_.start_date as start_110_440_, wbloandeta0_.strategy_type as strate111_440_, wbloandeta0_.subsidized_flg as subsid112_440_, wbloandeta0_.subsidized_int as subsid113_440_, wbloandeta0_.tenement_fee as teneme114_440_, wbloandeta0_.terminate_date as termin115_440_, wbloandeta0_.terminate_reason_cd as termin116_440_, wbloandeta0_.type_of_cust as type_o117_440_, wbloandeta0_.upgrade_flg as upgrad118_440_, wbloandeta0_.used_locat as used_l119_440_, wbloandeta0_.wto_date as wto_da120_440_ from wb_loandetail wbloandeta0_ cross join pr_cc_organization_table prccorgani1_ where wbloandeta0_.bus_date=prccorgani1_.today and prccorgani1_.id='80000023' order by wbloandeta0_.id desc limit 60000, 10000; | 多字段                                                       |                                                              |
|  29  | select  ifnull(contract_no,''), ifnull(calc_date,''), ifnull(accrued_status,''), ifnull(DATE_ADD(business_date,INTERVAL 1 DAY),''), ifnull(DATE_ADD(last_update_time,INTERVAL 1 DAY),''), ifnull(DATE_ADD(create_time,INTERVAL 1 DAY),'') FROM ants_loan_calc INTO OUTFILE "/data1/ants_loan_calc.csv" CHARACTER SET GBK; | ifnull func                                                  |                                                              |
|      |                                                              |                                                              |                                                              |
|      |                                                              |                                                              |                                                              |





如何快速看出来。 串行 并行







测试问题；



基准 DB版本：	8.0.33-v24-txsql-22.6.1-20240611 Proxy版本：	proxy-22.4.1 20240516 18462aacb

![image-20240719161541905](/Users/lukatai/Library/Application Support/typora-user-images/image-20240719161541905.png)







双升级  DB版本： 8.0.33-v24-txsql-22.7.0-20240716 Proxy版本： proxy-22.4.2 20240716 a81a19de4 

sql14存在波动



![image-20240719161617371](/Users/lukatai/Library/Application Support/typora-user-images/image-20240719161617371.png)

![image-20240719161635265](/Users/lukatai/Library/Application Support/typora-user-images/image-20240719161635265.png)





升级db

![image-20240719161728718](/Users/lukatai/Library/Application Support/typora-user-images/image-20240719161728718.png)



**升级proxy**

![image-20240719161757734](/Users/lukatai/Library/Application Support/typora-user-images/image-20240719161757734.png)



