

## ref

[“0”基础了解腾讯云分布式数据库_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1NV411p7be?p=5&vd_source=50d188aa88eda541803a8b30c0b28e5d)







## 数据强一致性

确保多副本架构下数据强一致，避免故障后导致集群数据错乱和丢失。



<img src="分布式数据库纵览.assets/image-20240701144025441.png" alt="image-20240701144025441" style="zoom: 33%;" />



## 拜占庭将军问题的结论

如果三个节点中有一个异常节点，那么最坏情况下两个正常节点之间是无法保证一致性的。



## TDSQL核心架构

zookeeper 奇数，需要做投票任务

OSS 赤兔要访问集群，需要访问OSS的接口

scheduler 任务调度

kafka 缓存到kafka消息队列，依赖于zookeeper

SQL引擎：Proxy

![image-20240701150122162](分布式数据库纵览.assets/image-20240701150122162.png)



![image-20240701152445592](分布式数据库纵览.assets/image-20240701152445592.png)









## Apache ZooKeeper 理解

Apache ZooKeeper 是一个分布式协调服务，主要用于管理和协调分布式系统中的各种服务和组件。为了更通俗地理解ZooKeeper的功能，可以将其比作一个“分布式系统的管理员”或“协调者”。以下是一些关键功能和对应的通俗解释：

### 1. **分布式配置管理**

**通俗解释**：想象你在一个大型公司工作，公司有很多分支机构，每个分支都有自己的配置文件。ZooKeeper就像一个中央配置管理员，确保所有分支机构都能访问到最新的配置文件。如果配置文件有更新，ZooKeeper会通知所有分支机构。

**实际功能**：ZooKeeper可以存储和管理分布式系统的配置信息，确保所有节点都能访问到一致的配置数据。

### 2. **命名服务**

**通俗解释**：在一个大城市中，有很多街道和建筑物，每个建筑物都有一个唯一的地址。ZooKeeper就像城市的地址管理系统，确保每个服务或资源都有一个唯一的名字，方便其他服务找到它们。

**实际功能**：ZooKeeper提供命名服务，允许分布式系统中的组件通过唯一的路径来标识和访问资源。

### 3. **分布式锁**

**通俗解释**：想象你和你的朋友们在一个图书馆里，每个人都想借同一本书。为了避免冲突，图书馆管理员会给每个人发一个号码，按顺序借书。ZooKeeper就像这个管理员，确保每个请求都能按顺序处理，避免资源冲突。

**实际功能**：ZooKeeper提供分布式锁机制，确保多个客户端在访问共享资源时不会发生冲突。

### 4. **领导选举**

**通俗解释**：在一个团队中，需要选出一个队长来带领大家完成任务。ZooKeeper就像一个公平的选举委员会，确保在团队中选出一个领导者，并在领导者失效时重新选举。

**实际功能**：ZooKeeper可以帮助分布式系统进行领导选举，确保在集群中有一个节点作为领导者来协调工作。

### 5. **集群管理**

**通俗解释**：想象你在一个大型活动中，活动组织者需要知道每个参与者的状态（比如是否到场、是否需要帮助等）。ZooKeeper就像这个组织者，实时监控每个参与者的状态，并在状态变化时通知相关人员。

**实际功能**：ZooKeeper可以监控分布式系统中各个节点的状态，并在节点状态变化时通知其他节点。

### 6. **分布式队列**

**通俗解释**：在一个餐厅里，顾客按顺序排队点餐。ZooKeeper就像餐厅的排队系统，确保每个顾客都能按顺序得到服务。

**实际功能**：ZooKeeper可以实现分布式队列，确保多个客户端按顺序处理任务。

### 总结

ZooKeeper的主要功能是帮助分布式系统中的各个组件进行协调和管理，确保系统的一致性、可靠性和高可用性。通过提供配置管理、命名服务、分布式锁、领导选举、集群管理和分布式队列等功能，ZooKeeper使得分布式系统的开发和运维变得更加简单和高效。





## 分布式事务实现机制

分布式数据库的中间状态怎么避免

分布式数据库解决的问题：海量存储和性能问题



![image-20240701153645502](分布式数据库纵览.assets/image-20240701153645502.png)

### 什么是事务：



![image-20240701153848942](分布式数据库纵览.assets/image-20240701153848942.png)

![image-20240701155137872](分布式数据库纵览.assets/image-20240701155137872.png)





## XA

XA 是一种分布式事务处理协议，最初由 X/Open（现为 Open Group）定义。它用于在分布式系统中协调多个资源管理器（如数据库、消息队列等）参与的全局事务。XA 协议确保了分布式事务的原子性、一致性、隔离性和持久性（ACID 属性）。





## binlog的作用

mysql是多引擎的，为了保证引擎之间的原子性，binlog发挥了协调者的作用

 分布式数据库，必须要使用 mysql 5.7 版本以上



binlog日志不能回滚

![image-20240701162105114](分布式数据库纵览.assets/image-20240701162105114.png)





## 分布式事务读一致性

两阶段提交解决事务原子性，分布式事务读一致性怎么解决

两个节点上的关联数据，怎么解决同时处理问题呢？

![image-20240701162609951](分布式数据库纵览.assets/image-20240701162609951.png)

### 读一致性的现象



![image-20240701162634485](分布式数据库纵览.assets/image-20240701162634485.png)



### 串行的隔离级别

所有的select都被堵塞，mysql使用

![image-20240701162735492](分布式数据库纵览.assets/image-20240701162735492.png)



### GTM（Global Transacation Manager）

拥有一个全局时间戳，TBASE就是使用该方法

![image-20240701162858738](分布式数据库纵览.assets/image-20240701162858738.png)

GTM访问瓶颈：网络带宽，并且主不能分片

### GLobal Timestamp

![image-20240701163324123](分布式数据库纵览.assets/image-20240701163324123.png)



MC（metacluster）的功能

![image-20240701163621892](分布式数据库纵览.assets/image-20240701163621892.png)

 

![image-20240701163842542](分布式数据库纵览.assets/image-20240701163842542.png)

select操作的时间戳要大于commit的时间戳，才能进行读取，如果小于，需要使用redulog进行回退读取。如果被读取数据的状态为prepare，则等待数据commit



# TDSQL高可用

### 两个主流流派

![image-20240701170951742](分布式数据库纵览.assets/image-20240701170951742.png)



###  TDSQL强同步复制

mysql的异步，半同步（从库存在timeout），同步

前提：必须有两个以上的备库，如果恰好两个备都坏了，那么我的主库降级为only-read

<img src="分布式数据库纵览.assets/image-20240701171942730.png" alt="image-20240701171942730" style="zoom:33%;" />



### 容灾切换

![image-20240701172305420](分布式数据库纵览.assets/image-20240701172305420.png)

## 部署方案（高可用架构）

![image-20240701172557746](分布式数据库纵览.assets/image-20240701172557746.png)

### 同城单中心

![image-20240701173008840](分布式数据库纵览.assets/image-20240701173008840.png)

### 同城双中心

![image-20240701173347011](分布式数据库纵览.assets/image-20240701173347011.png)



![image-20240701173510301](分布式数据库纵览.assets/image-20240701173510301.png)



![image-20240701195141519](分布式数据库纵览.assets/image-20240701195141519.png)





### 同城三中心

![image-20240701195254093](分布式数据库纵览.assets/image-20240701195254093.png)



![image-20240701195326721](分布式数据库纵览.assets/image-20240701195326721.png)

![image-20240701195554903](分布式数据库纵览.assets/image-20240701195554903.png)

### 两地三中心

![image-20240701195624714](分布式数据库纵览.assets/image-20240701195624714.png)



### 两地四中心

![image-20240701200009188](/Users/lukatai/Library/Application Support/typora-user-images/image-20240701200009188.png)



## 数据共享分类

shared-everything

shared-storge

shared-nothing



![image-20240702105654637](分布式数据库纵览.assets/image-20240702105654637.png)



Oracle Real Application Clusters（RAC）是 Oracle 数据库的一项高级功能，允许多个服务器（节点）共享同一个数据库，从而提供高可用性、可扩展性和高性能。RAC 通过在多个节点上运行一个数据库实例，实现了负载均衡和故障转移，确保数据库系统的高可用性和可靠性。



## 分表方案

垂直切分（即“分业务”）

![image-20240702112102061](分布式数据库纵览.assets/image-20240702112102061.png)

水平切分（分数据量）

![image-20240702112149404](分布式数据库纵览.assets/image-20240702112149404.png)

使用分片字段（shardkey）进行切分

![image-20240702112236689](分布式数据库纵览.assets/image-20240702112236689.png)

## TDSQL的典型实现

![image-20240702112336350](分布式数据库纵览.assets/image-20240702112336350.png)





### Proxy

权限校验，读写分离，词法分析，语法分析，路由选择（决定储存set位置），分布式任务，全局自增(每个proxy会分配自己的自增数据范围)，统计信息，聚合函数

![image-20240702114059804](分布式数据库纵览.assets/image-20240702114059804.png)



### 数据节点（set）

![image-20240702114837017](分布式数据库纵览.assets/image-20240702114837017.png)

使用binlog进行主从同步

## TDSQL典型特点

### 水平扩容

![image-20240702114942707](分布式数据库纵览.assets/image-20240702114942707.png)

配置SQL引擎的时候，便会设置最大分片数

zookeeper控制sql路由信息，增加set后，会先进行数据复制，然后zookeeper开始调整sql路由信息，后续set缓慢删除重复数据，避免快速删除造成性能波动。



### 强同步

![image-20240702153816079](分布式数据库纵览.assets/image-20240702153816079.png)

 

主库写完信息后，必须等待备库接收到binlog信息

### 读写分离

SQL引擎实现

![image-20240702154115926](分布式数据库纵览.assets/image-20240702154115926.png)



### 容灾切换

![image-20240702154332271](分布式数据库纵览.assets/image-20240702154332271.png)



当master失效，会把失效信息上报给zookeeper，而scheduler会监控zookeepr的信息，如果确认master生效，则会进行主备切换；备节点通过agent上报binlog，选取binlog偏移量小（即备和主binlog差距较小）的备为后续的主节点。后续scheduler重建主备关系，scheduler更新zk中的路由表，proxy将请求转发给新的主db



### 完整的分布式事务（事务原子性）



## 分布式数据库的使用

### 表类型

分表

![image-20240702155652115](分布式数据库纵览.assets/image-20240702155652115.png)

单表

![image-20240702160203772](/Users/lukatai/Library/Application Support/typora-user-images/image-20240702160203772.png)

广播表

![image-20240702160447748](分布式数据库纵览.assets/image-20240702160447748.png)



复制表呢？

分表操作

![image-20240702160705441](分布式数据库纵览.assets/image-20240702160705441.png)



 

## 分布式事务的实现原理

业界的两阶段提交

![image-20240702161945631](分布式数据库纵览.assets/image-20240702161945631.png)



![image-20240702162004229](分布式数据库纵览.assets/image-20240702162004229.png)





![image-20240702162152487](分布式数据库纵览.assets/image-20240702162152487.png)



TDSQL 分布式事务的实现原理



![image-20240702162731145](分布式数据库纵览.assets/image-20240702162731145.png)

![image-20240702162719862](分布式数据库纵览.assets/image-20240702162719862.png)

重点：prepare后，就已经持久化了



## DISTRIBUTION 字段解释

在分布式数据库系统中，`DISTRIBUTION` 字段用于指定数据的分布策略

### DISTRIBUTION=SHARDING

`SHARDING` 是一种将数据水平分片的技术。它将数据分散到多个物理节点上，以提高数据库的可扩展性和性能。每个分片（shard）包含数据的一个子集，查询时可以并行处理多个分片，从而提高查询效率。

#### 1. `REPLICATION`

`REPLICATION` 是将数据复制到多个节点上，以提高数据的可用性和容错性。每个节点都有完整的数据副本，写操作需要同步到所有副本，读操作可以从任意副本读取。

#### 2. `HASH`

`HASH` 是基于哈希函数将数据分布到不同的节点上。通常使用主键或其他唯一标识符作为哈希键，以确保数据均匀分布。

#### 3. `RANGE`

`RANGE` 是基于数据的范围将数据分布到不同的节点上。适用于数据有明显范围划分的场景，如时间序列数据。

#### 4. `LIST`

`LIST` 是基于预定义的列表将数据分布到不同的节点上。适用于数据有明确分类的场景。

### 选择分布策略的考虑因素

1. **数据访问模式**：如果读多写少，`REPLICATION` 可能更合适；如果读写均衡，`SHARDING` 或 `HASH` 可能更合适。
2. **数据分布均匀性**：`HASH` 通常能保证数据均匀分布，而 `RANGE` 和 `LIST` 需要根据具体数据特点进行设计。
3. **容错性和可用性**：`REPLICATION` 提供高可用性和容错性，但写操作开销较大。
4. **查询性能**：`SHARDING` 和 `HASH` 可以提高查询性能，但需要处理跨分片查询的复杂性。
